CREATE PROCEDURE sp_account_opening_attempts_summary_grafana                     
    @StartDate DATETIME,                      
    @EndDate DATETIME 
	
AS                   
BEGIN  

                
SELECT                       
    Remark,                      
    AttemptCount,                      
    CAST(100.0 * AttemptCount / SUM(AttemptCount) OVER () AS DECIMAL(5, 2)) AS Percentage,                      
CASE                       
        WHEN tbl.remark IN (                      
            'NIN detail not found',     
            'NIN information not found',                     
            'Customer already has an account , please login',                      
            'Sent OTP to preferred number, pending validation',                      
            'Sorry, you must be at least 18 years old to open an account online. Please visit your nearest FCMB branch for assistance with opening an account.',                      
            'Initiated facial verification , pending validation',                      
            'Initiated Journey',                      
            'Successful primary KYC validation',                      
            'Failed to validate phone number for primary kyc [FACIAL]',                      
            'BVN information not found',                      
            'The customer already exists on Finacle',                      
            'The provided phone number does not match the registered phone number associated with the BVN.',                      
            'The provided phone number does not match the registered phone number associated with the NIN.',                      
            'Date of birth does not match with your BVN',                      
            'Date of birth does not match with your NIN',                      
            'Failed to validate phone number for primary kyc',                      
            'Failed facial verification',                      
            'Successful resumption',                      
            'Successfully validated phone number for primary kyc [FACIAL]',                      
            'Initiated facial verification , pending validation',                      
            'Successful facial verification',                      
            'phone number is null',                      
            'Invalid phone number provided',                  
            'Successfully validated phone number using facial verification',                   
            'Unable to verify your image. Kindly ensure your face is fully captured in the display box, then try again' 
        ) OR tbl.remark like '%must be digits%' 
          OR  tbl.remark like '%birthYear must be%' 
          OR tbl.remark like '%age is above allowed age%' 
          OR tbl.remark like 'Referralcode%' 
          OR tbl.remark like '%age is%'  
		   THEN 'Customer Induced'                      
                       
        WHEN tbl.remark IN (                  
            'An error occurred, try again!',                  
            'We are temporarily unable to verify the image , kindly retry again',                
            'Error response from service',  
           'Bvn validation service unavailable due to maintenance.'  
        ) OR tbl.remark LIKE '%getmati.com%'
           THEN 'External Induced'                  
                  
        WHEN tbl.remark IN (                      
            'Account creation failed. No Account Number returned Request Successful',                       
            'Internal Server Error: Contact System Administrator- Error occured while creating CIF ID',            
            'facial verification initiation| Unable to upload image',
			'No record found',
			--'Successfully validated phone number using facial verification', 
			'sleep interrupted',
			'Finacle System Error Occoured!!! Please contact System Administrator.'
        ) OR tbl.remark LIKE 'I/O error on POST request%' 
		  OR tbl.remark LIKE 'Error creating account at this time%'
		  OR tbl.remark LIKE 'Error while extracting response for type%'
          OR tbl.remark LIKE 'For input string: "W0205%'
		  --OR tbl.remark LIKE '%getmati.com%'
		THEN 'System Induced'                      
                       
        WHEN tbl.remark IN (                    
            'Account successfully created'                    
        )                    
        THEN 'Successful'                      
                       
        ELSE 'Unclassified'                      
    END AS Remark_classification,                      
                       
    CASE                
        WHEN tbl.remark = 'phone number is null'                      
            THEN 'No phone number provided by the customer'                      
        WHEN tbl.remark = 'Invalid phone number provided' OR tbl.remark like '%must be digits%'                      
            THEN 'Customer failed to provide a valid phone number'                      
        WHEN tbl.remark = 'Account successfully created'                    
            THEN 'The account was created successfully'                      
        WHEN tbl.remark = 'NIN detail not found'                      
            THEN 'Missing or invalid customer-supplied NIN'     
        WHEN tbl.remark = 'NIN information not found'                      
            THEN 'Missing or invalid customer-supplied NIN'                     
        WHEN tbl.remark = 'Customer already has an account , please login'                      
           THEN 'Customer already exists in system'                      
        WHEN tbl.remark = 'Sent OTP to preferred number, pending validation'                      
            THEN 'Customer needs to complete OTP step'                    
        WHEN tbl.remark = 'Sorry, you must be at least 18 years old to open an account online. Please visit your nearest FCMB branch for assistance with opening an account.'                   
            THEN 'Customer is underage' 
        WHEN tbl.remark LIKE '%age is below allowed age%'                   
            THEN 'Customer is underage'                          
        WHEN tbl.remark = 'Initiated facial verification , pending validation'                      
            THEN 'Customer action required to complete validation'                      
        WHEN tbl.remark = 'Account creation failed. No Account Number returned Request Successful'                      
            THEN 'Backend failed to return expected account number'                      
        WHEN tbl.remark = 'Initiated Journey'                      
            THEN 'Customer started onboarding process'                      
        WHEN tbl.remark = 'Successful primary KYC validation'                      
            THEN 'Customer provided valid KYC info'                      
        WHEN tbl.remark = 'Failed to validate phone number for primary kyc [FACIAL]'                      
            THEN 'Customer’s phone number doesn’t match'                      
        WHEN tbl.remark = 'BVN information not found'                      
            THEN 'Invalid or missing BVN from customer'                      
        WHEN tbl.remark = 'The customer already exists on Finacle'                      
            THEN 'Duplicate customer entry'                      
        WHEN tbl.remark = 'The provided phone number does not match the registered phone number associated with the BVN.'                      
            THEN 'Mismatch in customer data'                      
        WHEN tbl.remark = 'The provided phone number does not match the registered phone number associated with the NIN.'                      
            THEN 'Mismatch in customer data'                      
        WHEN tbl.remark = 'Internal Server Error: Contact System Administrator- Error occured while creating CIF ID'                      
            THEN 'Server or system-side failure'                      
        WHEN tbl.remark = 'Date of birth does not match with your BVN'                      
            THEN 'Data mismatch from customer'                      
        WHEN tbl.remark = 'Date of birth does not match with your NIN'                      
            THEN 'Data mismatch from customer'                      
        WHEN tbl.remark = 'Failed to validate phone number for primary kyc'                      
            THEN 'Phone number not verified'                      
        WHEN tbl.remark = 'Failed facial verification'                      
            THEN 'Customer facial mismatch'                      
        WHEN tbl.remark = 'Unable to verify your image. Kindly ensure your face is fully captured in the display box, then try again'                    
            THEN 'Image failed quality checks – poor lighting, misalignment, or incomplete face'             
        WHEN tbl.remark = 'An error occurred, try again!'                  
            THEN 'Rova API not reachable'    
        --WHEN tbl.remark = 'Referralcode must be at least 4 characters long'                  
            --THEN 'Incorret referral code / Incorrectly inputted referral code'                  
        WHEN tbl.remark = 'Error response from service'                  
            THEN 'Rova API was unavailable'                  
        WHEN tbl.remark = 'We are temporarily unable to verify the image , kindly retry again'                  
            THEN 'Timeout awaiting response from Metamap'       
        WHEN tbl.remark = 'Successfully validated phone number using facial verification'                
            THEN 'Customer not proceeding after verification'            
        WHEN tbl.remark = 'facial verification initiation| Unable to upload image'                
            THEN 'System failed to upload customer image'
		WHEN tbl.remark LIKE '%getmati.com%'
		    THEN 'Timeout awaiting response from Metamap'
        WHEN tbl.remark LIKE 'I/O error on POST request%'                      
            THEN 'System integration or connectivity failure'                  
    	WHEN tbl.remark LIKE '%birthYear must be%'         
      	    THEN 'Customer ID contains invalid date of birth'  
        WHEN tbl.remark LIKE '%age is%'  
            THEN 'Age is not allowed' 
		WHEN tbl.remark LIKE 'Referralcode%'                  
            THEN 'Incorret referral code / Incorrectly inputted referral code'
		WHEN tbl.remark LIKE 'Error while extracting response for type%'
		    THEN 'Integration error'
        WHEN tbl.remark = 'Bvn validation service unavailable due to maintenance.'  
            THEN 'NIBBS BVN Maintenance' 
		WHEN tbl.remark = 'No record found'  
            THEN 'Empty validation record at validation' 
		WHEN tbl.remark = 'sleep interrupted'  
            THEN 'Interruption in Kyc validation' 
		WHEN tbl.remark LIKE 'Error creating account at this time%'	
		    THEN 'Unable to reach Finacle at the moment!'
        WHEN tbl.remark LIKE 'For input string: "W0205%'
            THEN 'Account already exist'
		WHEN tbl.remark = 'Finacle System Error Occoured!!! Please contact System Administrator.'      
           THEN 'Finacle System Error'
        ELSE 'Requires more context'                      
    END AS Remark_reason                      
                      
FROM (                      
                          
SELECT                       
        CASE                       
            WHEN p.account_number is not null THEN 'Account successfully created'                      
            WHEN a.current_step IN ('INITIATION') THEN a.initiation_remark                      
            WHEN a.current_step IN ('KYC_VALIDATION', 'RESUMPTION', 'FACIAL_VALIDATION') AND p.account_number is null THEN a.kyc_validation_remark                      
            WHEN a.current_step IN ('CREATION') THEN a.creation_remark                      
            WHEN a.current_step IN ('PROFILING') THEN a.creation_remark                      
            ELSE a.initiation_remark                       
        END AS remark,                      
        COUNT(1) AS AttemptCount                     
    FROM                       
        [10.5.251.138].[Omni_Channel_DB].[dbo].[digital_onboarding_attempts] a                      
    LEFT JOIN                       
        [10.5.251.138].[Omni_Channel_DB].[dbo].[digital_onboarding_profile] p                      
        ON a.id_type = p.id_type                       
        AND a.id_number = p.id_number                      
    WHERE                       
        a.time_first_attempted BETWEEN @StartDate AND @EndDate                 
        AND (current_step <> 'INITIATION' OR (current_step = 'INITIATION' AND initiation_status NOT IN ('SUCCESSFUL')))                   
    GROUP BY                       
  CASE                       
   WHEN p.account_number is not null THEN 'Account successfully created'                      
            WHEN a.current_step IN ('INITIATION') THEN a.initiation_remark                      
            WHEN a.current_step IN ('KYC_VALIDATION', 'RESUMPTION', 'FACIAL_VALIDATION') AND p.account_number is null THEN a.kyc_validation_remark                      
            WHEN a.current_step IN ('CREATION') THEN a.creation_remark                      
       WHEN a.current_step IN ('PROFILING') THEN a.creation_remark                      
            ELSE a.initiation_remark       
        END                      
) tbl                      
                       
ORDER BY                       
    tbl.AttemptCount DESC;                      
END;

